import { NextRequest, NextResponse } from 'next/server'

function md5(s: string) {
  const crypto = require('crypto') as typeof import('crypto')
  return crypto.createHash('md5').update(s).digest('hex')
}

// –§–æ—Ä–º–∞—Ç —Å—É–º–º—ã –¥–ª—è FK: –±–µ–∑ –ª–∏—à–Ω–∏—Ö –Ω—É–ª–µ–π (199 –≤–º–µ—Å—Ç–æ 199.00),
// –Ω–æ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–ø–µ–π–∫–∏ (199.50)
function formatAmountForFK(amountRub: number | string): string {
  const n = Number(amountRub)
  if (!Number.isFinite(n)) return '0'
  const fixed = n.toFixed(2)
  // —É–±–∏—Ä–∞–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–∏–µ –Ω—É–ª–∏ –∏ –≤–æ–∑–º–æ–∂–Ω—É—é —Ç–æ—á–∫—É
  return fixed.replace(/\.00$/, '').replace(/\.0$/, '').replace(/\.$/, '')
}

export async function POST(req: NextRequest) {
  try {
    const { amountRub, sessionId, product = 'spins_10', orderId } = await req.json()

    if (!amountRub || !sessionId) {
      return NextResponse.json({ success: false, error: 'amountRub and sessionId are required' }, { status: 400 })
    }

    const merchantId = (process.env.FK_MERCHANT_ID_OVERRIDE || process.env.FK_MERCHANT_ID || '').trim()
    const secret1 = (process.env.FK_SECRET_1_OVERRIDE || process.env.FK_SECRET_1 || '').trim()

    console.log('üîß DEBUG FK CONFIG:', {
      merchantId,
      secret1,
      override_merchant: process.env.FK_MERCHANT_ID_OVERRIDE,
      override_secret: process.env.FK_SECRET_1_OVERRIDE
    })

    if (!merchantId || !secret1) {
      return NextResponse.json({ success: false, error: 'FreeKassa not configured' }, { status: 500 })
    }

    const amount = formatAmountForFK(amountRub)
    const oid = orderId || `${Date.now()}_${Math.floor(Math.random() * 1e6)}`

    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∏ FK - –∏–Ω–æ–≥–¥–∞ –æ–Ω–∏ –º–µ–Ω—è—é—Ç —Ñ–æ—Ä–º–∞—Ç
    const variants = [
      [merchantId, amount, secret1, oid].join(':'),                    // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
      [merchantId, amount, secret1, 'RUB', oid].join(':'),             // —Å –≤–∞–ª—é—Ç–æ–π  
      [merchantId, amount, 'RUB', secret1, oid].join(':'),             // –≤–∞–ª—é—Ç–∞ –ø–µ—Ä–µ–¥ —Å–µ–∫—Ä–µ—Ç–æ–º
      [oid, merchantId, amount, secret1].join(':'),                    // order_id –ø–µ—Ä–≤—ã–π
      [secret1, merchantId, amount, oid].join(':'),                    // —Å–µ–∫—Ä–µ—Ç –ø–µ—Ä–≤—ã–π
    ]
    
    console.log('üîß DEBUG ALL VARIANTS:', variants.map((v, i) => ({ 
      variant: i+1, 
      string: v, 
      hash: md5(v).toUpperCase() 
    })))
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    const signString = variants[0]
    const sign = md5(signString).toUpperCase()

    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –¥–æ–º–µ–Ω FK
    const url = new URL('https://pay.freekassa.ru/')
    url.searchParams.set('m', String(merchantId))
    url.searchParams.set('oa', String(amount))
    url.searchParams.set('o', oid)
    url.searchParams.set('currency', 'RUB')
    url.searchParams.set('us_session', sessionId)
    url.searchParams.set('us_product', product)
    url.searchParams.set('s', sign)
    url.searchParams.set('lang', 'ru')

    return NextResponse.json({ success: true, link: url.toString(), orderId: oid })
  } catch (e) {
    console.error('freekassa create-link error', e)
    return NextResponse.json({ success: false, error: 'Internal error' }, { status: 500 })
  }
}


